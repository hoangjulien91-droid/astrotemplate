---
/**
 * S-TIER — YouTube Facade Component
 * Lazy-loads YouTube iframe only on click (Facade Pattern)
 * ZERO impact on initial LCP
 */

interface Props {
  videoId: string;
  title?: string;
  thumbnailQuality?: "default" | "mq" | "hq" | "sd" | "maxres";
}

const {
  videoId,
  title = "Regarder la vidéo",
  thumbnailQuality = "maxres",
} = Astro.props;

// YouTube thumbnail URL
const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/${thumbnailQuality}default.jpg`;
---

<div class="youtube-facade" data-video-id={videoId}>
  <!-- Thumbnail (loads immediately, lightweight) -->
  <img
    src={thumbnailUrl}
    alt={title}
    class="youtube-facade__thumbnail"
    loading="lazy"
    decoding="async"
  />

  <!-- Play Button -->
  <button class="youtube-facade__play" aria-label={`Lire : ${title}`}>
    <svg viewBox="0 0 68 48" width="68" height="48">
      <path
        class="youtube-facade__play-bg"
        d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z"
        fill="#f00"></path>
      <path d="M 45,24 27,14 27,34" fill="#fff"></path>
    </svg>
  </button>
</div>

<style>
  .youtube-facade {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: var(--color-bg-tertiary);
    border-radius: 0.75rem;
    overflow: hidden;
    cursor: pointer;
  }

  .youtube-facade__thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .youtube-facade:hover .youtube-facade__thumbnail {
    transform: scale(1.02);
  }

  .youtube-facade__play {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
    transition:
      transform 0.3s ease,
      opacity 0.3s ease;
  }

  .youtube-facade:hover .youtube-facade__play {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .youtube-facade__play-bg {
    transition: fill 0.2s ease;
  }

  .youtube-facade:hover .youtube-facade__play-bg {
    fill: #cc0000;
  }

  /* Iframe state - when video is loaded */
  .youtube-facade.loaded {
    cursor: default;
  }

  .youtube-facade.loaded .youtube-facade__thumbnail,
  .youtube-facade.loaded .youtube-facade__play {
    display: none;
  }

  .youtube-facade iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
    border-radius: 0.75rem;
  }
</style>

<script>
  // Facade pattern: Load iframe only on click
  document.querySelectorAll(".youtube-facade").forEach((facade) => {
    facade.addEventListener("click", function (this: HTMLElement) {
      const videoId = this.dataset.videoId;
      if (!videoId || this.classList.contains("loaded")) return;

      // Create and insert iframe
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      iframe.allow =
        "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      iframe.title = "YouTube video";

      this.appendChild(iframe);
      this.classList.add("loaded");
    });
  });
</script>
